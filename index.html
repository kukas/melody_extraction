<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style>
	body {
		padding: 0;
	}
	#canvas {
		position: absolute;
		top:0;
		left:0;
		z-index: -10;
	}
	.controls {
		position: absolute;
		top:2em;
		left:2em;
		z-index: 10;
	}
	</style>
	<script src="jquery-3.2.0.min.js"></script>
<script>
$(document).ready(function () {
	var canvas = $("#canvas")[0];
	var width = canvas.width = window.innerWidth;
	var height = canvas.height = window.innerHeight;
	var ctx = canvas.getContext("2d");
	var player = new Audio();
	var notes = [];
	var estimation = [];
	var rangeMin = 100;
	var rangeMax = 1000;

	function change(){
		$("#playButton").prop('disabled', true);
		player.src = $("#audioSrc").val();
		$.get($("#melSrc").val(), function(a){
			notes = [];
			var lines = a.split("\n");
			var first = true;
			lines.forEach(function (line) {
				if(!line)
					return true;
				line = line.split(/\s+/, 2);
				console.log(line);
				line[0] = parseFloat(line[0]);
				line[1] = parseFloat(line[1]);
				if(line[1] == 0)
					return true;
				if(first){
					rangeMax = line[1];
					rangeMin = line[1];
					first = false;
				}
				rangeMin = Math.min(line[1], rangeMin);
				rangeMax = Math.max(line[1], rangeMax);
				notes.push(line);
			});

			$.get($("#estSrc").val(), function(a){
				estimation = [];
				var lines = a.split("\n");
				lines.forEach(function (line) {
					if(!line)
						return true;
					line = line.split(/\s+/, 2);
					console.log(line);
					line[0] = parseFloat(line[0]);
					line[1] = parseFloat(line[1]);
					if(line[1] == 0)
						return true;

					if(line[1] > 0)
						rangeMin = Math.min(line[1], rangeMin);
					rangeMax = Math.max(line[1], rangeMax);
					estimation.push(line);
				});
			});
		});
	}
	change();

	$("#changeButton").click(change);
	$("#playButton").click(function () {
		player.play();
	});
	$("#stopButton").click(function () {
		player.pause();
	});

	// $("#audioSrc").on("keyup", function () {
	// 	var val = $("#audioSrc").val();
	// 	if(val.substring(0, 5) != "audio"){
	// 		$("#audioSrc").val("audio/stereo/"+val)
	// 		$("#melSrc").val("GT/"+val.substring(0, val.length-4)+".mel");
	// 	}
	// });

	player.addEventListener("canplaythrough", function () {
		$("#playButton").prop('disabled', false);
	});

	function freqToNote(freq){
		return 12*Math.log(freq/440)/Math.log(2)+49;
	}

	function render(){
		window.requestAnimationFrame(render);

		// rangeMin = 100;
		// rangeMax = 1000;
		var timeScale = 100;
		// pianoroll
		// for(var i = 0; i < 48; i++){

		// }
		ctx.clearRect(0, 0, width, height);

		var noteMin = freqToNote(rangeMin)-3;
		var noteMax = freqToNote(rangeMax)+3;

		var noteHeight = height/(noteMax-noteMin);
		// var noteNames = ["A", "A#", "H", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
		for (var i = 0; i < noteMax-noteMin; i++) {
			ctx.fillStyle = i%2==0 ? "#fff" : "#eee";
			ctx.fillRect(0, i*noteHeight, width, noteHeight);
			
			// ctx.fillStyle = i%2==0 ? "#fff" : "#eee";
			// ctx.fillRect(0, i*noteHeight, width, noteHeight);
		}

		var currentTimeScaled = player.currentTime*timeScale;
		ctx.save();
		if(currentTimeScaled > width/2){
			ctx.translate(Math.round(-currentTimeScaled+width/2), 0);
		}
		for (var i = 0; i < notes.length; i++) {
			var note = notes[i];
			ctx.fillStyle = "#00dd5c";
			var noteY = height-(freqToNote(note[1])-noteMin)*noteHeight
			ctx.fillRect(note[0]*timeScale, noteY, 1, noteHeight);


			if(noteY > height || noteY < 0){
				ctx.fillStyle = "#800";
				ctx.fillRect(note[0]*timeScale, Math.max(0, Math.min(noteY, height))-2, 1, 5);
			}
		}
		for (var i = 0; i < estimation.length; i++) {
			var note = estimation[i];
			ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
			var noteY = height-(freqToNote(note[1])-noteMin)*noteHeight
			ctx.fillRect(note[0]*timeScale, noteY, 1, noteHeight);


			if(noteY > height || noteY < 0){
				ctx.fillStyle = "#800";
				ctx.fillRect(note[0]*timeScale, Math.max(0, Math.min(noteY, height))-2, 1, 5);
			}
		}
		ctx.fillStyle = "#ff0000";
		ctx.fillRect(currentTimeScaled, 0, 3, height);
		ctx.restore();
	}
	render();
});
</script>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="controls">
	<input size="70" id="audioSrc" placeholder="audio file" value="Orchset/audio/stereo/Musorgski-Ravel-PicturesExhibition-ex5.wav"><br>
	<input size="70" id="melSrc" placeholder="mel file" value="Orchset/GT/Musorgski-Ravel-PicturesExhibition-ex5.mel"><br>
	<input size="70" id="estSrc" placeholder="estimation file" value="ALGORITHMS/SourceFilterContoursMelody/src/estimations/audio3.txt"><br>
	<button id="changeButton">load</button>
	<button id="playButton">play</button>
	<button id="stopButton">stop</button>
</div>
</body>
</html>